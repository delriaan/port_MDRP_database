---
title: "Question I: Correlation"
date: 2023-07-13
date-modified: last-modified
---

```{r}
#| label: SETUP
#| echo: false
#| warning: false
#| message: false

knitr::opts_chunk$set(opts_chunk = list(cache=TRUE, cache.lazy=TRUE, warning=FALSE, message=FALSE))
source("setup.R");

if ("global_drug_obs_smart_data" %in% .cache$keys()){
  cache_load(.cache, "drug_obs_smart_data");
  drug_obs_smart_data$cache_mgr(action = upd);
} else {
  stop("This section needs to be updated");
  
  drug_obs_smart_data <- smart.data$
    new(x = drug_obs_data, name = "drugs")$
    taxonomy.rule(!!!drug_taxonomy)$
    enforce.rules(for_usage)$
    cache_mgr(action = upd) |>
    invisible();
  
  cache_prep(drug_obs_smart_data) |> cache_save(.cache);
}

if ("global_drug_taxonomy" %in% .cache$keys()){
  cache_load(.cache, "drug_taxonomy");
} else {
  stop("This section needs to be updated");
  cache_prep(drug_taxonomy) |> cache_save(.cache);
}

```

I decided to start asking some questions of the data given the metrics defined earlier.  I decided to look into the correlation between pairs of metrics relative to a third:

"How does the correlation between `days_to_market` and `on_market_age`|`days_market_absent` change by route of administration?":

```{r}
#| label: METRICS_CORRELATION
#| echo: false

# Define a base object
.tmp_obj <- get.smart("drugs")$
  use(identifier, metrics, retain = c(route), subset = days_to_market >= 0) |> 
  # View() 
  setkey(route, alt_ndc, days_to_market, on_market_age);

# Create the first visualization focused on the correlation between days to market and on market age
drug_metric_oma_viz <- plot_metric_cor(.tmp_obj, metric = on_market_age);

# Create the second visualization focused on the correlation between days to market and days market absent
drug_metric_dma_viz <- plot_metric_cor(.tmp_obj, metric = days_market_absent);

# Create the third visualization focused on the correlation between days to market and days market absent
drug_metric_dma_oma_viz <- plot_metric_cor(.tmp_obj, metric = days_market_absent, primary_metric = on_market_age);

# Create the combined visualization
drug_metric_viz <- subplot(
  drug_metric_oma_viz
  , drug_metric_dma_viz
  , drug_metric_dma_oma_viz
  , nrows = 1
  , shareX = FALSE
  , shareY = TRUE
  , titleX = TRUE
  , titleY = TRUE
  );

# Send to cache
cache_prep(drug_metric_dma_viz) |> cache_save(.cache);
cache_prep(drug_metric_oma_viz) |> cache_save(.cache);
cache_prep(drug_metric_dma_oma_viz) |> cache_save(.cache);
cache_prep(drug_metric_viz) |> cache_save(.cache);

# Render the combined visualization
.cache$get("global_drug_metric_viz") |> tagList()
```

[Market age relative to days to market shows more variability in correlation distribution. This is not to make an claim of statistically significant differentiation; however, it may be worth exploring whether or not there are clusters of administration routes based on event correlation. A future update may address this, but this is as deep of exploration I'll go for now.]{style="display:block; margin-top:1.1em;"}
